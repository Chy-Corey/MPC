## 无人机自主安全控制方法研究与验证

根据文章摘要，以下几点工作与我们的设想场景相关：

1. 无故障情况下的**碰撞规避**问题，基于约束、障碍物，提出了一种**路径规划**方法（基于变栅格策略的快速收敛路径规划方法）。猜测该方法应用于最上层（路径规划）。
2. **执行器故障**情况下任务品质下降和能力降级问题，基于系统模型、故障信息、设备状态，进行**轨迹重新规划**。（这里的轨迹指的是参考路径）
3. 考虑**干扰**的执行器故障情况下的飞行安全问题，在第二点的基础上考虑了干扰。
4. 在第三点基础上考虑**模型不确定**。



第 2 点和第 3 点和研究场景相关较大。



### 一、研究现状

#### 安全控制系统研究现状

<img src=".\image\02-01.png" alt="02-01" style="zoom:60%;" />

如图所示，导航模块为最上层，通过机载传感器实时感知周围环境信息（导航），接着进入第二层，基于对获取信息的在线分析处理生成路径并对其进行优化（制导） ， 最终进入第三层，根据参考轨迹自主完成预设战术任务（控制）。

#### 路径规划研究现状

<img src=".\image\02-02.png" alt="02-02" style="zoom:60%;" />

图 1.7 展示了无人机避障的原理与流程， 包括：

1. 利用机载传感器获取无人机周围飞行**环境信息**；
2. 基于传感器提供的数据， 碰撞检测单元提取有用信息， 根据当前飞行器的状态信息来判断在未来一段时间发生碰撞的概率， 当前对碰撞的定义为两个或多个飞行器在一段时间内超出了**最小安全距离标准**；  
3. 航迹规划单元根据预测碰撞的相关参数如发生碰撞的位置、时间， 结合无人机的动力学特性以及燃油经济性， **规划航迹**以规避障碍物， 保证飞行安全。  

<img src=".\image\02-03.png" alt="02-03" style="zoom:60%;" />

关于无人机路径规划技术，按照其研究原理进行分类，主要可以分成以下五类方法， 如图 1.8 所示。  



### 二、基于系统能力量化的容错控制方法（轨迹重构部分）

#### 问题描述

运动学方程、执行器力矩以及动力学方程：

![02-04](.\image\02-04.png)

![02-05](.\image\02-05.png)

![02-06](.\image\02-06.png)

由于并不关心无人机的模型细节，只需要知道物理量的意义即可：

$[𝑥, 𝑦, 𝑧]^𝑇$代表四旋翼无人机在地面坐标系的位置， $[𝜙, 𝜃, 𝜓]^𝑇$ 代表无人机地面坐标系和机体坐标系的夹角，分别为滚转角、俯仰角、偏航角， $[𝑚, 𝑔]$ 分别代表无人机质量和重心加速度， $𝐹_𝑧$ 代表无人机四个执行器的总推力， $[𝑑_𝑥, 𝑑_𝑦, 𝑑_𝑧]^𝑇$分别表示位置环三轴的干扰。 $T_i$ 表示桨叶产生的推力，$T_i=K_fu_i$  ，$K_f$ 是推理系数。

$[𝜏_𝑥, 𝜏_𝑦, 𝜏_𝑧]^𝑇$ 代表执行器作用在三个坐标轴方向的主动力矩， $[𝑤, 𝑙]$ 表示无人机滚转和俯仰力臂中心到末端长度， $𝐾_𝑐$表示力矩增益系数。   

$[𝐼_𝑥, 𝐼_𝑦, 𝐼_𝑧]^𝑇$ 表示三个坐标轴对应的转动惯量， $[𝑑𝜙, 𝑑𝜃, 𝑑𝜓]^𝑇$ 代表姿态环的干扰。

通过以下表格展示参数意义：

<img src=".\image\02-08.png" alt="02-08" style="zoom:67%;" />

执行器故障表示为：

<img src=".\image\02-07.png" alt="02-07" style="zoom:67%;" />



#### 轨迹重构算法设计

旋翼无人机飞行过程的典型运动模态包括起飞、悬停、各类机动飞行等，对于上述飞行模式应当明确**分析系统能力**，以避免因**期望机动超出系统能力**造成跟踪精度下降甚至飞行失控。提出的轨迹重构方法基本上可以分为三个步骤：

1. 反推轨迹跟踪过程，从而**构建执行器输入与无人机状态的显性表达式**，在此基础上分析系统能力变化与生成轨迹的关系；（判断系统能力）
2. 根据正常工作状态下四旋翼无人机能力，结合微分平坦技术设计满足任务需求的参考轨迹；（生成正常工况下的参考轨迹）
3. 发生执行器故障后，量化分析系统能力降级程度并重构飞行轨迹以避免超出安全裕度。（根据故障情况评估系统能力，进行轨迹重构）

##### 1. 系统能力分析

假设无人机水平面飞行，四个执行器的推力在垂直方向正好抵消重力，且偏航角和偏航力矩为零，忽略外界干扰且角度（$[𝜙, 𝜃, 𝜓]$）很小，四旋翼无人机运动学、动力学模型可以简化为：

<img src=".\image\02-09.png" alt="02-09" style="zoom:67%;" />

根据 $T_i=K_fu_i$ 以及式（3.2），可以得出：

<img src=".\image\02-10.png" alt="02-10" style="zoom:67%;" />

<img src=".\image\02-11.jpg" alt="02-11" style="zoom:20%;" />

**矩阵 $\Gamma_1$ 是满秩的，所以可以求逆。** 

观察式（3.9），$u_1$ 所代表的执行器 #1 承担了四分之一的机身重量，同时作用于滚转角和偏航角。

如果滚转、偏航机动所需要的推力和力矩**超出了能力范围**，则有可能引发飞行失控（即饱和导致的稳定性丧失）。因此，文章下一步的研究工作为设计一条**考虑飞行轨迹机动性**和**执行器脉冲输入限制**关系的飞行轨迹，以确保四旋翼无人机的飞行安全。即轨迹考虑到了执行器饱和。  

##### 2. 轨迹重构方法

飞行航迹起点为 $(x_s,y_s,z_s)$ ，终点为 $(x_f,y_f,z_f)$ 。由于考虑的是水平飞行，所以 $z_s=z_f$ 。考虑到四旋翼无人机电机脉冲响应输入极限（执行机构饱和），设计如下函数表示参考航迹（轨迹的变化比较平滑）：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-11.png" alt="02-11" style="zoom:67%;" />  

其中，$k_1=[1-(1+w_nt)e^{-w_nt}],w_n>0$ 。$w_n$ 表示需要设计的航迹调节参数， $w_n$ 越大，对时间的感应越敏锐，即参考轨迹的变化越激烈。 

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-12.png" alt="02-12" style="zoom:67%;" />

图中绿色和蓝色分别表示 $w_n=0.5，w_n=1$ 的 $k_1$ 随时间变化曲线。

将式（3.10）对时间求二阶导，结合式（3.5），可以得到参考俯仰角 $\theta_v$ 和参考滚转角 $\phi_v$ ：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-13.png" alt="02-13" style="zoom:67%;" />

将式（3.11）代入（3.9）：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-14.png" alt="02-14" style="zoom:67%;" />

其中， $𝑤_{𝑛1}$指的是相对于执行器#1 脉冲输入的调节参数， $𝑢_{ℎ𝑜𝑣𝑒𝑟}$ = 0.538为真实环境中通过大量实验得出的结果，即四个正常工作的执行器脉冲输入数值为 0.538 正好可以维持无人机悬停状态，类似地可以得到其他三个执行器的脉冲输入表达式。执行器的脉冲输入限制为 $𝑢_1(𝑡) ≤ 𝜌$，其中常数 $0 < 𝜌 ≤ 1$ 表示给定的安全系数。 

对 $𝑢_1(𝑡)$ 求导可知，在时间 $𝑡 = \frac{4}{𝑤_𝑛}$ 时，其导数 $\dot{𝑢}_1(𝑡) = 0$ ，此时可得其极值。进一步地，基于时间点 $𝑡 = 0$ 与 $𝑡 = 𝑡_𝑠$ 可以分别得到其初始值与稳态值。通过比较上述三值，可以得到 $𝑢_1(𝑡)$ 时变过程中的最大值，结合执行器限制可以计算得到调节参数 $𝑤_{𝑛1}$ 的表达式为：

（式 3.13 直接将 $t=0$ 代入 3.12 即可，观察 3.12 ，t=0 时 $u_1$ 取最大值）

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-15.png" alt="02-15" style="zoom:67%;" />

$\Delta_1=\frac{3I_x(x_f-x_s)}{wK_fg} + \frac{3I_y(y_f-y_s)}{lK_fg}$ 。

根据 $w_{n1}$ 其余三个执行器的调节参数也可以得出： 

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-16.png" alt="02-16" style="zoom:67%;" />

$\Delta_2=\frac{3I_x(x_f-x_s)}{wK_fg} - \frac{3I_y(y_f-y_s)}{lK_fg}，\Delta_3=-\frac{3I_x(x_f-x_s)}{wK_fg} + \frac{3I_y(y_f-y_s)}{lK_fg}，\Delta_4=-\frac{3I_x(x_f-x_s)}{wK_fg} - \frac{3I_y(y_f-y_s)}{lK_fg}$ 。

那么为了防止执行器饱和，保证无人机飞行安全，需要满足以下条件：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-17.png" alt="02-17" style="zoom:67%;" />

这是**正常工况**下，防止执行机构饱和的参考指令需要满足的条件。

当执行器故障发生时，系统能力下降将影响到飞行任务成功率。将正常飞行状态时四个执行器对应限制定义为$[1, 1, 1, 1]^𝑇$ ，则根据公式(3.4)可以得到故障后实际的执行器限制为$[𝜆_1, 𝜆_2, 𝜆_3, 𝜆_4]^𝑇$。  需要对正常工况下的参考轨迹进行重构。

重规划航迹需要考虑以下因素：

1. 轨迹重构前后满足参考轨迹的连续性，同时保证仍然能够到达目的地；
2.  重新设计轨迹调节参数，从而延长任务时间，以缓解受损执行器工作负担；
3. 在轨迹切换阶段，执行器应避免剧烈运动。  

文章的重构方式比较简洁，重构参考轨迹表示如下：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-18.png" alt="02-18" style="zoom:67%;" />

其中，$k_2=[1-(1+w_{F_1}t)e^{-w_{F_1}t}]$ ，$t_{det}$ 为故障诊断完成的时刻，$w_{F_1}$ 为重构轨迹的调节参数。

为了满足上述的第三点，在故障诊断完成的时刻，需要满足 $w_{F_1}(t=t_{det})=w_n$ ，然后平滑地过渡到：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-19.png" alt="02-19" style="zoom:67%;" />

$w_{F_2}$ 和 $w_n$ 的区别在于多了一个 $\lambda$ 乘积。

那么 $w_{F_1}$ 需要从正常工况下的 $w_n$ 平滑地过渡到故障情况下的 $w_{F_2}$ 即可：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-20.png" alt="02-20" style="zoom:67%;" />

$k_4=0.5$ 。

那么将正常和故障情况结合起来，则可以得到以下表达式：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-21.png" alt="02-21" style="zoom:67%;" />





### 三、轨迹动态调节的避障算法

本章在第 3 章基础上提出了基于轨迹动态调节的抗干扰容错控制方法，做了以下工作：

1. 首先， 基于欧拉朗格朗日方程来描述无人机动力学模型，并对执行器故障和外界干扰进行分析建模。
2.  其次， 将 **Q-learning 算法和能力量化技术结合提出了轨迹动态调节方法**，对故障和干扰条件下的系统能力进行量化分析，**为飞行轨迹在线调节提供理论依据**。 
3. 最后，通过双环非线性观测器实时估计外界干扰和执行器故障（本文第 3 章假设故障信息已知） ，结合设计的基础控制器，保证极端工作条件下的系统稳定性。   

本章提出的方法框架如下所示：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-22.png" alt="02-22" style="zoom:67%;" />

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-23.png" alt="02-23" style="zoom:67%;" />



#### 轨迹动态调节方法

本节结合 **Q-learning 算法**和干扰故障量化分析方法，提出了一种轨迹动态调节方法，在**规避飞行环境中障碍物**的同时，根据干扰故障后系统能力降级程度动态调节飞行轨迹甚至是紧急降落以保证飞行稳定和无人机安全。  

##### 1. 避障算法

Q-learning 算法是强化学习中 value-based 的方法，其主要思想是构建一张状态和动作 Q 值表，然后根据 Q 值选取获得最大收益的策略。 本节设计了基于 Q-learning 算法的路径规划方法以规避环境中的静态障碍物：

无人机选择动作 $a_t$ 从而进入状态 $s_{t+1}$ ， 同时通过和环境交互获得奖励信号 $r_t$ 。无人机根据当前状态以及奖励信号选择下一个动作 $a_{t+1}$ ， 通过最大化期望奖励信号实现策略选取（贪婪策略） ，重复上述过程直到完成既定的目标。

在状态 s 执行动作 a ， 立即奖励函数可以表示为 ：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-24.png" alt="02-24" style="zoom:67%;" />

奖励函数需包含两部分：

1. 为了确保无人机和障碍物之间的距离维持在安全距离以外的奖励：

   <img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-25.png" alt="02-25" style="zoom:67%;" />

   其中， $d_{obs}$ 和 $𝑑_𝑠$ 分别代表无人机和障碍物间的欧氏距离以及设定的安全距离。 𝑤1表示权重。  

2. 为了尽可能接近目的地的奖励：

   <img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-26.png" alt="02-26" style="zoom:67%;" />

   其中， $𝑠_{𝑔𝑜𝑎𝑙}$ 代表目的地状态， 即如果无人机到达目的地， 则给与 100 的奖励， 反之奖励值为 0， 𝑤2表示针对接近目的地的权重系数。  

那么综合的奖励函数表达式为：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-27.png" alt="02-27" style="zoom:67%;" />

Q-learning 算法通过搜索动作， 最大化状态动作值函数$𝑄(𝑠_𝑡, 𝑎_𝑡)$ ，Q-learning 算法的求解包括以下步骤： ①根据无人机当前所处的环境， 包括获得的起点、终点、障碍物信息，初始化决策系统参数； ②无人机在当前状态 $𝑠_𝑡$ 下从动作集合中选择最好的动作并更新表格； ③根据新的状态𝑠𝑡+1， 无人机继续选择下一个动作直到到达目的地。  

$𝑄(𝑠_𝑡, 𝑎_𝑡)$ 可以表示为：

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-28.png" alt="02-28" style="zoom:67%;" />

式为值函数的迭代更新公式，$0 < \alpha \leq 1$ 为学习率。通过最大化操作乘以衰减系数 𝛾 加上立即奖励， 同时结合经验值来逼近真实的值。 衰减系数 𝛾 的值越大代表对未来回报的权重越大， 同时对当前经验的权重则相应降低， 有助于加速算法收敛。  

<img src="E:\Library\硕士实验室\MPC\Note\2024_4\reference planning\image\02-29.png" alt="02-29" style="zoom:67%;" />

##### 2. 轨迹优化方法

通过 Q-learning 生成的参考路径包含较大的偏转角， 可能导致旋翼无人机通过剧烈运动跟踪期望轨迹。然而实际旋翼无人机存在固有的能力限制， 包括执行器脉冲输入饱和限制， 无人机在飞行时需要避免超出电机脉冲输入极限，所以需要对生成的参考轨迹进行优化。 

与第二章节完全相同。
